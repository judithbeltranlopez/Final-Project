---
title: "EDA Schools"
author: "Judith Beltrán"
date: "2025-11-17"
output: html_document
---

```{r}
library(readxl)
library(dplyr)

schools_df <- read_excel("../data/Data_on_Individual_Schools_Mainstream_2024_25.xlsx", sheet=2)
schools_df <- schools_df%>%rename("Roll_Number" = "Roll Number")%>%rename("longitude" = "School Longitude")%>%rename("latitude" = "School Latitude")


schools_df <- schools_df %>%
  rename(
    AcademicYear = `Academic Year (Enrolment)`,
    SchoolName   = `Official Name`
  )
```

```{r}
library(sf)
library(rnaturalearth)
library(ggplot2)

world <- ne_countries(scale = "medium", returnclass = "sf")

ireland <- world[world$admin == "Ireland", ]
```
```{r}

schools_df_clean <- schools_df[complete.cases(schools_df[, c("longitude", "latitude")]), ] # clean null

schools_sf <- st_as_sf(
  schools_df_clean,
  coords = c("longitude", "latitude"),
  crs = 4326
)

# Plot
ggplot() +
  geom_sf(data = ireland) +
  geom_sf(data = schools_sf) +
  labs(
    title = "Schools in Ireland",
    subtitle = "Points located using coordinates"
  )

```

```{r}
ggplot(schools_df, aes(x = `School Type`)) +
  geom_bar() +
  coord_flip() +
  labs(
    title = "Number of schools by School Type",
    x = "School Type",
    y = "Number of schools"
  )

```

```{r}
ggplot(schools_df, aes(x = Female, y = Male)) +
  geom_point(alpha = 0.5) +
  labs(
    title = "Female vs Male enrolment per school",
    x = "Female enrolment",
    y = "Male enrolment"
  )

```



```{r}

schools_sf <- st_as_sf(
  schools_df_clean,
  coords = c("longitude", "latitude"),
  crs = 4326,
  remove = FALSE
)

ggplot() +
  geom_sf(data = ireland) +
  geom_sf(data = schools_sf, aes(colour = `School Level`), size = 0.7, alpha = 0.8) +
  labs(title = "Schools in Ireland by Level")

```
```{r}
schools_df_clean <- schools_df %>% 
  filter(!is.na(latitude), !is.na(longitude))

ggplot(schools_df_clean, aes(x = longitude, y = latitude)) +
  geom_point(aes(colour = `County Description`), alpha = 0.7, size = 1) +
  coord_equal() +
  theme_minimal() +
  labs(colour = "County")

ggplot(schools_df_clean, aes(x = longitude, y = latitude)) +
  geom_point(size = 0.7, alpha = 0.7) +
  facet_wrap(~ `County Description`) +
  coord_equal() +
  theme_minimal()

```


```{r}
# install if needed:
# install.packages(c("rnaturalearth", "rnaturalearthdata"))

library(sf)
library(dplyr)
library(gstat)
library(stars)
library(ggplot2)
library(rnaturalearth)
library(rnaturalearthdata)

## 1. Get counties for Ireland (admin-1 level)
ireland_counties <- st_read("../data/gadm41_IRL_shp/gadm41_IRL_2.shp")


## 2. Filter to Galway and project
galway <- ireland_counties %>%
  filter(NAME_1 == "Galway")

galway_proj <- st_transform(galway, 2157)

## 3. Prepare school points (you already had this)
schools_sf <- st_as_sf(
  schools_df_clean,
  coords = c("longitude", "latitude"),
  crs = 4326,
  remove = FALSE
)

schools_sf <- st_transform(schools_sf, 2157)
schools_sf$enrolment <- as.numeric(schools_sf$`Enrolment per Return`)

# Keep only schools inside Galway
schools_krig <- schools_sf[galway_proj, ] %>%
  filter(!is.na(enrolment))

## 4. Make a grid only over Galway
grid <- st_make_grid(
  galway_proj,
  cellsize = 5000,
  what = "centers"
)

grid <- st_sf(grid_id = seq_along(grid), geometry = grid)
grid <- grid[galway_proj, ]

## 5. Kriging *only for Galway*
vgm_emp <- variogram(enrolment ~ 1, data = schools_krig)
vgm_model <- fit.variogram(vgm_emp, vgm("Sph"))

krig_result <- krige(
  enrolment ~ 1,
  locations = schools_krig,
  newdata    = grid,
  model      = vgm_model
)

krig_stars <- st_rasterize(krig_result["var1.pred"])

## 6. Plot Galway kriging result
ggplot() +
  geom_stars(data = krig_stars) +
  scale_fill_viridis_c(name = "Predicted\nEnrolment") +
  geom_sf(data = galway_proj, fill = NA, color = "black") +
  geom_sf(data = schools_krig, color = "red", size = 0.7) +
  labs(title = "Kriged Enrolment Surface – County Galway") +
  theme_minimal()


```




```{r}
# install if needed:
# install.packages(c("sf", "dplyr", "gstat", "stars", "ggplot2"))

library(sf)
library(dplyr)
library(gstat)
library(stars)
library(ggplot2)

## 1. Read counties shapefile for Ireland (admin-1 level)
ireland_counties <- st_read("../data/gadm41_IRL_shp/gadm41_IRL_2.shp")

# Dissolve to a single Ireland outline for kriging extent
ireland_outline <- st_union(ireland_counties)
ireland_outline_proj <- st_transform(ireland_outline, 2157)

# Also keep projected counties for plotting borders
ireland_counties_proj <- st_transform(ireland_counties, 2157)

## 2. Prepare school points
schools_sf <- st_as_sf(
  schools_df_clean,
  coords = c("longitude", "latitude"),
  crs = 4326,
  remove = FALSE
)

schools_sf <- st_transform(schools_sf, 2157)
schools_sf$enrolment <- as.numeric(schools_sf$`Enrolment per Return`)

# Keep only schools inside Ireland and with non-missing enrolment
schools_krig <- schools_sf[ireland_outline_proj, ] %>%
  filter(!is.na(enrolment))

## 3. Make a grid over all of Ireland
grid <- st_make_grid(
  ireland_outline_proj,
  cellsize = 5000,
  what = "centers"
)

grid <- st_sf(grid_id = seq_along(grid), geometry = grid)
grid <- grid[ireland_outline_proj, ]   # clip grid to Ireland

## 4. Kriging for all Ireland
vgm_emp <- variogram(enrolment ~ 1, data = schools_krig)
vgm_model <- fit.variogram(vgm_emp, vgm("Sph"))

krig_result <- krige(
  enrolment ~ 1,
  locations = schools_krig,
  newdata   = grid,
  model     = vgm_model
)

krig_stars <- st_rasterize(krig_result["var1.pred"])

## 5. Plot kriging result with county borders
ggplot() +
  geom_stars(data = krig_stars) +
  scale_fill_viridis_c(name = "Predicted\nEnrolment") +
  geom_sf(data = ireland_counties_proj, fill = NA, color = "black", linewidth = 0.2) +
  geom_sf(data = schools_krig, color = "red", size = 0.7) +
  labs(title = "Kriged Enrolment Surface – All of Ireland") +
  theme_minimal()

```




```{r}
```


```{r}
```