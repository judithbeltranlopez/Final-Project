---
title: "EDA Schools"
author: "Judith Beltrán"
date: "2025-11-17"
output: html_document
---

```{r}
library(readxl)
library(dplyr)

schools_df <- read_excel("../data/Data_on_Individual_Schools_Mainstream_2024_25.xlsx", sheet=2)
schools_df <- schools_df%>%rename("Roll_Number" = "Roll Number")%>%rename("longitude" = "School Longitude")%>%rename("latitude" = "School Latitude")


schools_df <- schools_df %>%
  rename(
    AcademicYear = `Academic Year (Enrolment)`,
    SchoolName   = `Official Name`
  )
```

```{r}
library(sf)
library(rnaturalearth)
library(ggplot2)

world <- ne_countries(scale = "medium", returnclass = "sf")

ireland <- world[world$admin == "Ireland", ]
```
```{r}

schools_df_clean <- schools_df[complete.cases(schools_df[, c("longitude", "latitude")]), ] # clean null

schools_sf <- st_as_sf(
  schools_df_clean,
  coords = c("longitude", "latitude"),
  crs = 4326
)

# Plot
ggplot() +
  geom_sf(data = ireland) +
  geom_sf(data = schools_sf) +
  labs(
    title = "Schools in Ireland",
    subtitle = "Points located using coordinates"
  )

```

```{r}
ggplot(schools_df, aes(x = `School Type`)) +
  geom_bar() +
  coord_flip() +
  labs(
    title = "Number of schools by School Type",
    x = "School Type",
    y = "Number of schools"
  )

```

```{r}
ggplot(schools_df, aes(x = Female, y = Male)) +
  geom_point(alpha = 0.5) +
  labs(
    title = "Female vs Male enrolment per school",
    x = "Female enrolment",
    y = "Male enrolment"
  )

```



```{r}

schools_sf <- st_as_sf(
  schools_df_clean,
  coords = c("longitude", "latitude"),
  crs = 4326,
  remove = FALSE
)

ggplot() +
  geom_sf(data = ireland) +
  geom_sf(data = schools_sf, aes(colour = `School Level`), size = 0.7, alpha = 0.8) +
  labs(title = "Schools in Ireland by Level")

```
```{r}
schools_df_clean <- schools_df %>% 
  filter(!is.na(latitude), !is.na(longitude))

ggplot(schools_df_clean, aes(x = longitude, y = latitude)) +
  geom_point(aes(colour = `County Description`), alpha = 0.7, size = 1) +
  coord_equal() +
  theme_minimal() +
  labs(colour = "County")

ggplot(schools_df_clean, aes(x = longitude, y = latitude)) +
  geom_point(size = 0.7, alpha = 0.7) +
  facet_wrap(~ `County Description`) +
  coord_equal() +
  theme_minimal()

```


```{r}
library(sf)
library(dplyr)
library(gstat)
library(stars)
library(ggplot2)

# 1. Filter schools for Galway only
schools_galway <- schools_df_clean %>%
  filter(`County Description` == "Galway")

# 2. Convert to sf
schools_sf <- st_as_sf(
  schools_galway,
  coords = c("longitude", "latitude"),
  crs = 4326,
  remove = FALSE
)

# 3. Project
schools_sf <- st_transform(schools_sf, 2157)

# 4. Extract Galway county polygon
galway_poly <- ireland %>% 
  filter(COUNTYNAME == "Galway") %>% 
  st_transform(2157)

# 5. Prepare enrolment
schools_sf$enrolment <- as.numeric(schools_sf$`Enrolment per Return`)

# Remove missing enrolments
schools_krig <- schools_sf %>% filter(!is.na(enrolment))

# 6. Build grid ONLY inside Galway
grid <- st_make_grid(
  galway_poly,
  cellsize = 5000,
  what = "centers"
)

grid <- st_sf(id = 1:length(grid), geometry = grid)
grid <- grid[galway_poly, ]

# 7. Build variogram and fit model
vgm_emp <- variogram(enrolment ~ 1, data = schools_krig)
vgm_model <- fit.variogram(vgm_emp, vgm("Sph"))

# 8. Kriging only for Galway
krig_result <- krige(
  enrolment ~ 1,
  locations = schools_krig,
  newdata = grid,
  model = vgm_model
)

# 9. Convert kriging output to raster
krig_stars <- st_rasterize(krig_result["var1.pred"])

# 10. Plot map ONLY for Galway
ggplot() +
  geom_stars(data = krig_stars) +
  scale_fill_viridis_c(name = "Predicted\nEnrolment") +
  geom_sf(data = galway_poly, fill = NA, color = "black", linewidth = 1) +
  geom_sf(data = schools_krig, color = "red", size = 0.7) +
  labs(title = "Kriged Enrolment Surface — Galway Only") +
  theme_minimal()


```




```{r}
```




```{r}
```


```{r}
```